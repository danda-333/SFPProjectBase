<?xml version="1.0" encoding="utf-8"?>
<WorkFlow xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" Ident="ResourceCreatorWorkFlow" xmlns:dsp="http://www.gappex.com/sfp/DataSource/Parameters" FormIdent="ResourceCreator" IsDefault="true" StartState="1" PackageIdent="Utility">
  <Definition>
    <States>
      <State Value="0" TitleResourceKey="Deleted_Utility" />
      <State Value="1" TitleResourceKey="New_Utility" />
      <State Value="2" TitleResourceKey="Created_Utility" />
    </States>
  </Definition>

  <ControlShareCodes>
    <ControlShareCode Ident="ShareEnableAll">
      <Controls>
        <FormControl Ident="Ident" IsReadOnly="false"/>
        <FormControl Ident="TextValue" IsReadOnly="false"/>
        <FormControl Ident="Group" IsReadOnly="false"/>
        <FormControl Ident="Prefix" IsReadOnly="false" IsVisible="true"/>
        <FormControl Ident="Postfix" IsReadOnly="false" IsVisible="true"/>
        <FormControl Ident="LanguageID" IsReadOnly="false"/>
        <FormControl Ident="ClearAfterSave" IsReadOnly="false"/>
        <FormControl Ident="ForceUpdate" IsReadOnly="false"/>
      </Controls>
    </ControlShareCode> <!--<FormControl xsi:type="ShareCodeControl" Ident="ShareEnableAll"/>-->

    
    <ControlShareCode Ident="ShareEnableReduced">
      <Controls>
        <FormControl Ident="Ident" IsReadOnly="false"/>
        <FormControl Ident="TextValue" IsReadOnly="false"/>
        <FormControl Ident="Group" IsReadOnly="false"/>
        <FormControl Ident="LanguageID" IsReadOnly="false"/>
      </Controls>
    </ControlShareCode> <!--<FormControl xsi:type="ShareCodeControl" Ident="ShareEnableReduced"/>-->
  </ControlShareCodes>


  <ActionShareCodes>
    <ActionShareCode Ident="IdentityCheckAction">
      <Actions>
        
        <Action xsi:type="Required" ActionStart="BeforeValidation">
          <Idents>
            <string>Ident</string>
            <string>TextValue</string>
            <string>Group</string>
            <string>LanguageID</string>
          </Idents>
        </Action>

        <Action ActionStart="BeforeValidation" ErrorMessageResourceKey="DuplicationPrimaryKeyError_Utility" xsi:type="GlobalValidation">
          <Condition>
            <SQL>
              SELECT IIF(
                EXISTS(SELECT NULL FROM dbo.Resource WHERE UPPER([Key]) = UPPER(CONCAT(@Prefix,@Ident,@Postfix)) AND LanguageID = @LanguageID)
                AND @ForceUpdate = 0
              ,0,1)
            </SQL>
            <Parameters>
              <dsp:Parameter xsi:type="dsp:VariableParameter" Ident="Ident" DataType="String"/>
              <dsp:Parameter xsi:type="dsp:VariableParameter" Ident="Prefix" DataType="String"/>
              <dsp:Parameter xsi:type="dsp:VariableParameter" Ident="Postfix" DataType="String"/>
              <dsp:Parameter xsi:type="dsp:VariableParameter" Ident="LanguageID" DataType="Number"/>

              <dsp:Parameter xsi:type="dsp:VariableParameter" Ident="ForceUpdate" DataType="Bool"/>
            </Parameters>
          </Condition>
          <ControlIdents>
            <string>Ident</string>
          </ControlIdents>
        </Action>
      </Actions>
    </ActionShareCode> <!--<Action xsi:type="ShareCode" Ident="IdentityCheckAction" />-->
    
    <ActionShareCode Ident="InsertResourceAction">
      <Actions>
        <Action xsi:type="ActionTrigger" Ident="Insert" ActionStart="AfterSave">
          <DataSource>
            <SQL>
              DECLARE @Key VARCHAR(400) = CONCAT(@Prefix, @Ident, @Postfix);

              IF NOT EXISTS(SELECT NULL FROM dbo.Resource WHERE UPPER([Key]) = UPPER(CONCAT(@Prefix,@Ident,@Postfix)) AND LanguageID = @LanguageID)
              BEGIN
                INSERT INTO dbo.Resource(
                  [Key]
                  ,[Value]
                  ,[LanguageID]
                  ,[IsSystem]
                  ,[State]
                  ,[Group]
                )
                VALUES(
                  @Key
                  ,@TextValue
                  ,@LanguageID
                  ,0
                  ,1
                  ,@Group
                )
              END

              IF EXISTS(SELECT NULL FROM dbo.Resource WHERE UPPER([Key]) = UPPER(CONCAT(@Prefix,@Ident,@Postfix)) AND LanguageID = @LanguageID) AND @ForceUpdate = 1
              BEGIN
                UPDATE dbo.Resource
                  SET [Value] = @TextValue
                WHERE UPPER([Key]) = UPPER(CONCAT(@Prefix,@Ident,@Postfix)) AND LanguageID = @LanguageID
              END

            </SQL>
            <Parameters>
              <dsp:Parameter xsi:type="dsp:VariableParameter" Ident="Ident" DataType="String"/>
              <dsp:Parameter xsi:type="dsp:VariableParameter" Ident="Prefix" DataType="String"/>
              <dsp:Parameter xsi:type="dsp:VariableParameter" Ident="Postfix" DataType="String"/>
              
              <dsp:Parameter xsi:type="dsp:VariableParameter" Ident="TextValue" DataType="String"/>
              <dsp:Parameter xsi:type="dsp:VariableParameter" Ident="Group" DataType="String"/>
              <dsp:Parameter xsi:type="dsp:VariableParameter" Ident="LanguageID" DataType="Number"/>

              <dsp:Parameter xsi:type="dsp:VariableParameter" Ident="ForceUpdate" DataType="Bool"/>
            </Parameters>
          </DataSource>
        </Action>
      </Actions>
    </ActionShareCode> <!--<Action xsi:type="ShareCode" Ident="InsertResourceAction" />-->

    <ActionShareCode Ident="ClearAction">
      <Actions>
        <Action xsi:type="ActionTrigger" Ident="Clear" ActionStart="AfterSave">
          <DataSource>
            <SQL>
              IF @ClearAfterSave = 1
              BEGIN
                UPDATE usr.ResourceCreator
                  SET
                    Ident = NULL
                    ,TextValue = NULL
                WHERE ID = @ID
              END

            </SQL>
            <Parameters>
              <dsp:Parameter xsi:type="dsp:VariableParameter" Ident="ID" DataType="Number"/>
              <dsp:Parameter xsi:type="dsp:VariableParameter" Ident="ClearAfterSave" DataType="Bool"/>
            </Parameters>
          </DataSource>
        </Action>
      </Actions>
    </ActionShareCode> <!--<Action xsi:type="ShareCode" Ident="ClearAction" />-->
  </ActionShareCodes>


  <Steps>
    <Step State="1" IsDefault="true">
      <Groups>
        <Group>
          <Permissions>
            <string>SuperAdmin</string>
          </Permissions>
          <Buttons>
            <Button Ident="SaveButton" IsVisible="true">
              <Actions>
                <Action xsi:type="ShareCode" Ident="IdentityCheckAction" />
                <Action xsi:type="ShareCode" Ident="InsertResourceAction" />
                <Action xsi:type="ShareCode" Ident="ClearAction" />

                <Action xsi:type="ChangeState" State="2" ActionStart="AfterSave" />
              </Actions>
            </Button>
            <Button Ident="SaveAndNextButton" IsVisible="true">
              <Actions>
                <Action xsi:type="ShareCode" Ident="IdentityCheckAction" />
                <Action xsi:type="ShareCode" Ident="InsertResourceAction" />
                <Action xsi:type="ShareCode" Ident="ClearAction" />

                <Action xsi:type="ChangeState" State="2" ActionStart="AfterSave" />
              </Actions>
            </Button>
          </Buttons>
          <Controls>
            <FormControl xsi:type="ShareCodeControl" Ident="ShareEnableAll"/>
          </Controls>
        </Group>
        <Group>
          <Permissions>
            <string>AdminSystemDial</string>
          </Permissions>
          <Buttons>
            <Button Ident="SaveButton" IsVisible="true">
              <Actions>
                <Action xsi:type="ShareCode" Ident="IdentityCheckAction" />
                <Action xsi:type="ShareCode" Ident="InsertResourceAction" />
                <Action xsi:type="ShareCode" Ident="ClearAction" />

                <Action xsi:type="ChangeState" State="2" ActionStart="AfterSave" />
              </Actions>
            </Button>
          </Buttons>
          <Controls>
            <FormControl xsi:type="ShareCodeControl" Ident="ShareEnableReduced"/>
          </Controls>
        </Group>
      </Groups>
    </Step>
    <Step State="2">
      <Groups>
        <Group>
          <Permissions>
            <string>SuperAdmin</string>
          </Permissions>
          <Buttons>
            <Button Ident="SaveButton" IsVisible="true" >
              <Actions>
                <Action xsi:type="ShareCode" Ident="IdentityCheckAction" />
                <Action xsi:type="ShareCode" Ident="InsertResourceAction" />
                <Action xsi:type="ShareCode" Ident="ClearAction" />
              </Actions>
            </Button>
            <Button Ident="SaveAndNextButton" IsVisible="true">
              <Actions>
                <Action xsi:type="ShareCode" Ident="IdentityCheckAction" />
                <Action xsi:type="ShareCode" Ident="InsertResourceAction" />
                <Action xsi:type="ShareCode" Ident="ClearAction" />

                <Action xsi:type="ChangeState" State="2" ActionStart="AfterSave" />
              </Actions>
            </Button>
            <Button Ident="DeleteButton" IsVisible="true">
              <Actions>
                <Action xsi:type="ChangeState" State="0" ActionStart="AfterSave" />
              </Actions>
            </Button>
          </Buttons>
          <Controls>
            <FormControl xsi:type="ShareCodeControl" Ident="ShareEnableAll"/>
          </Controls>
        </Group>
        <Group>
          <Permissions>
            <string>AdminSystemDial</string>
          </Permissions>
          <Buttons>
            <Button Ident="SaveButton" IsVisible="true">
              <Actions>
                <Action xsi:type="ShareCode" Ident="IdentityCheckAction" />
                <Action xsi:type="ShareCode" Ident="InsertResourceAction" />
                <Action xsi:type="ShareCode" Ident="ClearAction" />

                <Action xsi:type="ChangeState" State="2" ActionStart="AfterSave" />
              </Actions>
            </Button>
          </Buttons>
          <Controls>
            <FormControl xsi:type="ShareCodeControl" Ident="ShareEnableReduced"/>
          </Controls>
        </Group>
      </Groups>
    </Step>
  </Steps>
</WorkFlow>