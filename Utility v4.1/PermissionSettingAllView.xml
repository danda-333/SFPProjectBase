<?xml version="1.0" encoding="utf-8"?>
<DataView  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:dsp="http://www.gappex.com/sfp/DataSource/Parameters" Ident="PermissionSettingAllView" SegmentType="Admin" TitleResourceKey="PermissionSettingAllView_Utility" GroupTitleResourceKey="UtilityGroup" Priority="20" PackageIdent="Utility" IsCheckBox="true" DefaultFilterIdent="PermissionSettingFilter" ShareFilterIdent="PermissionSettingFilter">
  <AccessPermissions>
    <string>SuperAdmin</string>
  </AccessPermissions>
  <Buttons>
    <Button xsi:type="LinkButton" Ident="AddButton" FormIdent="PermissionSetting" TitleResourceKey="AddButton_Utility" />
    <Button xsi:type="LinkButton" Ident="RecountPermissions" TitleResourceKey="RecountPermissions_Utility" Url="~/Clear/RecountPermissions"></Button>
    <Button xsi:type="LinkButton" Ident="Clear" TitleResourceKey="Clear_Utility" Url="~/Clear"></Button>
  </Buttons>
  <DataSource>
		<Columns>
      <Column Ident="Row" IsPrimaryKey="true" IsVisible="false" />
			<Column Ident="ID" TitleResourceKey="ID" Width="10" />
      <Column Ident="Weight" TitleResourceKey="Weight_Utility" Width="5" />
      <Column Ident="PermissionResourceKey" TitleResourceKey="ResourceKey_Utility" Width="13" />
      <Column Ident="PermissionResourceKeyTranslated" TitleResourceKey="ResourceKeyTranslated_Utility" Width="13" IsTranslate="true"/>
      <Column Ident="IsComputed" TitleResourceKey="IsComputed_Utility" Width="5" />

      <Column Ident="RoleResourceKey" TitleResourceKey="RoleResourceKey_Utility" Width="13" />
      <Column Ident="RoleResourceKeyTranslated" TitleResourceKey="RoleResourceKeyTranslated_Utility" Width="13" IsTranslate="true" />
      <Column Ident="VisibleType" TitleResourceKey="VisibleType_Utility" Width="5" />
      <Column Ident="DefaultValue" TitleResourceKey="DefaultValue_Utility" Width="5" />
      <Column Ident="ParentRole" TitleResourceKey="ParentRole_Utility" Width="8" />

      <Column Ident="Copy" TitleResourceKey="CopyToImport_Utility" Width="8" />
		</Columns>
		<SQL>

      SELECT *
      FROM (
        SELECT 
          ROW_NUMBER() OVER(ORDER BY per.ID ASC) AS Row
          ,CONCAT('<a href="../../Form/Index/PermissionSetting?OldID=', per.ID, '">', per.ID, '</a>') AS ID
          ,per.Weight
          ,per.ResourceKey AS PermissionResourceKey
          ,per.ResourceKey AS PermissionResourceKeyTranslated
          ,per.IsComputed
          ,rol.ResourceKey AS RoleResourceKey
          ,rol.ResourceKey AS RoleResourceKeyTranslated
          ,rol.VisibleType
          ,rol.DefaultValue
          ,rolP.PermissionID AS ParentRole
          ,CONCAT(
            '<button type="button" class="btn btn-outline bg-pink-400 text-pink-800 btn-icon rounded-round ml-2" onclick="const elem=document.createElement(''textarea'');elem.value='''
              ,per.ID
              ,';'
              ,per.Weight
              ,';'
              ,per.ResourceKey
              ,';'
              ,per.IsComputed
              ,';'
              ,anr.Name
              ,';'
              ,rol.ResourceKey
              ,';'
              ,rol.VisibleType
              ,';'
              ,rol.DefaultValue
              ,';'
              ,anrP.Name
            ,''' + String.fromCharCode(13),document.body.appendChild(elem),elem.select(),document.execCommand(''copy''),document.body.removeChild(elem);"><i class="icon-copy3"></i></button>'
          ) AS Copy
        FROM dbo.Permission AS per
        LEFT JOIN dbo.Role AS rol ON rol.PermissionID = per.ID
        LEFT JOIN dbo.AspNetRoles AS anr ON anr.ID = rol.ASPNETRoleID
        LEFT JOIN dbo.AspNetRoles AS anrP ON anrP.ID = rol.ParentASPNETRoleID
        LEFT JOIN dbo.Role AS rolP ON rolP.ASPNETRoleID = rol.ParentASPNETRoleID
      ) AS tbl
      WHERE 1 = 1 #FILTER#
      ORDER BY ISNULL(tbl.ParentRole, tbl.ID) ASC, IIF(tbl.ParentRole IS NULL, 0,1) ASC
      
    </SQL>
		<Parameters>
			<dsp:Parameter xsi:type="dsp:ValueParameter" Ident="DeleteState" DataType="Number" Value="0" />
		</Parameters>
	</DataSource>

  <Sections>
    <Section xsi:type="ExportSection" Ident="BasicExportSection"  TitleResourceKey="BasicExport_Utility" >
      <DataSource>
        <Columns>
          <Column Ident="Row" IsPrimaryKey="true" IsVisible="false" />
          <Column Ident="ID" TitleResourceKey="ID_Utility" />
          <Column Ident="Weight" TitleResourceKey="Weight_Utility"/>
          <Column Ident="ResourceKey" TitleResourceKey="ResourceKey_Utility"/>
          <Column Ident="IsComputed" TitleResourceKey="IsComputed_Utility"/>
          <Column Ident="AnrName" TitleResourceKey="AnrName_Utility" />
          <Column Ident="RoleResourceKey" TitleResourceKey="RoleResourceKey_Utility"/>
          <Column Ident="RoleVisibleType" TitleResourceKey="RoleVisibleType_Utility"/>
          <Column Ident="RoleDefaultValue" TitleResourceKey="RoleDefaultValue_Utility"/>
          <Column Ident="ParentAnrName" TitleResourceKey="ParentAnrName_Utility"/>
        </Columns>
        <SQL>
          SELECT *
          FROM (
            SELECT 
              ROW_NUMBER() OVER(ORDER BY per.ID ASC) AS Row
              ,per.ID
              ,per.Weight
              ,per.ResourceKey
              ,per.IsComputed
              ,anr.Name AS AnrName
              ,rol.ResourceKey AS RoleResourceKey
              ,rol.VisibleType AS RoleVisibleType
              ,rol.DefaultValue AS RoleDefaultValue
              ,anrP.Name AS ParentAnrName
              FROM dbo.Permission AS per
              LEFT JOIN dbo.Role AS rol ON rol.PermissionID = per.ID
              LEFT JOIN dbo.AspNetRoles AS anr ON anr.ID = rol.ASPNETRoleID
              LEFT JOIN dbo.AspNetRoles AS anrP ON anrP.ID = rol.ParentASPNETRoleID
              LEFT JOIN dbo.Role AS rolP ON rolP.ASPNETRoleID = rol.ParentASPNETRoleID
          ) AS tbl
          WHERE 1 = 1 #FILTER#
          ORDER BY ISNULL(tbl.ParentAnrName, tbl.ID) ASC, IIF(tbl.ParentAnrName IS NULL, 0,1) ASC
        </SQL>
        <Parameters>
          <dsp:Parameter xsi:type="dsp:ValueParameter" Ident="DeleteState" DataType="Number" Value="0" />
        </Parameters>
      </DataSource>
    </Section>
  </Sections>

</DataView>